

{%extends 'base.html'%}

{% load i18n %}

{%block style%}
<!-- {% load static %}
<link rel="stylesheet" href="{% static "css/floating-labels.css" %}" /> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style type="text/css">

    :root {
  --input-padding-x: .75rem;
  --input-padding-y: .75rem;
}

html,
body {
  height: 100%;
}

/*body {
  display: -ms-flexbox;
  display: flex;
  -ms-flex-align: center;
  align-items: center;
  padding-top: 40px;
  padding-bottom: 40px;
  background-color: #f5f5f5;
}*/

.form-signin {
  width: 100%;
  max-width: 420px;
  padding: 15px;
  margin: auto;
}

.form-label-group {
  position: relative;
  margin-bottom: 1rem;
}

.form-label-group > input,
.form-label-group > label {
  padding: var(--input-padding-y) var(--input-padding-x);
}

.form-label-group > label {
  position: absolute;
  top: 0;
  left: 0;
  display: block;
  width: 100%;
  margin-bottom: 0; /* Override default `<label>` margin */
  line-height: 1.5;
  color: #495057;
  border: 1px solid transparent;
  border-radius: .25rem;
  transition: all .1s ease-in-out;
}

.form-label-group input::-webkit-input-placeholder {
  color: transparent;
}

.form-label-group input:-ms-input-placeholder {
  color: transparent;
}

.form-label-group input::-ms-input-placeholder {
  color: transparent;
}

.form-label-group input::-moz-placeholder {
  color: transparent;
}

.form-label-group input::placeholder {
  color: transparent;
}

.form-label-group input:not(:placeholder-shown) {
  padding-top: calc(var(--input-padding-y) + var(--input-padding-y) * (2 / 3));
  padding-bottom: calc(var(--input-padding-y) / 3);
}

.form-label-group input:not(:placeholder-shown) ~ label {
  padding-top: calc(var(--input-padding-y) / 3);
  padding-bottom: calc(var(--input-padding-y) / 3);
  font-size: 12px;
  color: #777;
}


 .go3d{  min-width:100px; 
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  text-align: center;
  padding: 10px;}

  .stocks_display{
  min-width:50px; max-width:50px; 
  box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.2),0 -1px 2px 0 rgba(0, 0, 0, 0.2);
  padding: 10px;
  margin-right:20px; 
border-radius: 25px;

}
.display_stock_form{

  box-shadow: 0 -2px 2px 0 rgba(0, 0, 0, 0.2), 0 4px 2px 0 rgba(0, 0, 0, 0.19);
/*  text-align: center;
*/  background-color: #ffffff;
  display: block;
  position: absolute;
  border-radius: 10px;
  margin-top:20px; 
  min-width: 300px;
  z-index: 1; 

}

.buttons_stock{
   min-width:100px; max-width:100px; 
  box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.2),0 -1px 2px 0 rgba(0, 0, 0, 0.2);
  padding: 10px;
  margin-right:20px; 
border-radius: 10px;
}

.fa {
  color: yellow;
}

div.stocks_display:hover , .buttons_stock:hover{
  box-shadow: 0 -3px 2px 0 rgba(0, 0, 0, 0.2), 0 6px 10px 2px rgba(0, 0, 0, 0.19);
}

.go3d_cool{   
  box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.2);
  padding: 10px;
  border-radius: 10px;
}

.slider{

  /*for handling the slider for expenses and sales and*/
}
.slidertwo{
  /*for handling stock slider*/
}

.column {
    float: left;
    width: 50%;

}


</style>
<link href="https://cdn.jsdelivr.net/npm/animate.css@3.5.1" rel="stylesheet" type="text/css">

{%endblock%}
{%block inputsearch%}

   <div id="searchsales" class="container">
    
   <nav class="navbar navbar-white fixed-top bg-white flex-md-nowrap p-0 shadow">
      <a class="navbar col-2  mr-0" href="#"> {{user.username}}</a>
      <input class="col-8 form-control form-control-dark w-100" type="text" placeholder="{% trans 'Search' %}" aria-label="Search">
      <ul class="navbar-nav px-3 col-2">
        <li class="nav-item text-nowrap">
          <a class="nav-link" href="#" ><i class="fa fa-search" aria-hidden="true" style="color:black;""></i></a>
        </li>
      </ul>
    </nav>

  </div>
    {%endblock%}


{%block content%}

<div id=debittaccount class="container" >


<!--  <h1>{% trans "Let's translate this" %}</h1>
 -->
 <!--  {% get_current_language as LANGUAGE_CODE %}
 --><!--  {{ LANGUAGE_CODE }}
 -->
<!--  <form  class="form-group row" action="{% url 'set_language' %}" method="post">{% csrf_token %}
 <div class="row">
       <input name="next" type="hidden" value="{{ redirect_to }}" class="form-control">
    <select class="custom-select form-control" name="language">
        {% get_current_language as LANGUAGE_CODE %}
        {% get_available_languages as LANGUAGES %}
        {% get_language_info_list for LANGUAGES as languages %}
        {% for language in languages %}
            <option value="{{ language.code }}"{% if language.code == LANGUAGE_CODE %} selected{% endif %}>
                {{ language.name_local }} ({{ language.code }})
            </option>
        {% endfor %}
    </select>
    <input class="btn btn-outline-primary form-control" type="submit" value="Go" />
 </div>

</form> -->


<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom" id="search">
  <h3 v-cloak v-if="isGrossprofit" >{% trans "Gross Profit"%}: <br> [[ number_to_Cash(getProfiLoss()) ]]</h3>
  <h3 v-cloak v-if="!isGrossprofit" >{% trans "Gross Loss" %}: <br>[[ number_to_Cash(getProfiLoss()) ]]</h3>

  <h3 v-cloak v-if="isNetprofit" >{% trans "Net Profit" %}:<br> [[number_to_Cash(getProfiLoss(false)) ]]
  <br>
  <!-- {% trans "Saving Amount" %} <br>
  [[number_to_Cash(getProfiLoss(false)*0.1) ]]
  
  </h3> -->

 <h3 v-cloak v-if="!isNetprofit" >{% trans "Net Loss" %}:<br> [[ number_to_Cash(getProfiLoss(false)) ]]</h3>

    <span v-cloak class="go3d" v-if="showbusiness" v-on:click="onShowBusiness()">
    <!-- need to solve how to tranlate this js variable (vue) -->
      [[selected_business]]
    </span>

   <div class="dropdown pull-right selectbuz" v-if="!showbusiness">
      <button class="btn btn-outline-dark dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <span data-feather="calendar" v-cloak></span>
                      {% trans "Business" %}
      </button>

      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
      <span v-on:click="onShowBusiness()"><a class="dropdown-item" href="#" v-on:click="filterAccounts('','{% trans 'All' %}','')" >{% trans "All" %} </a></span>
      <span v-on:click="onShowBusiness()"v-for="business in businesses">

         <a class="dropdown-item" href="#" v-on:click="filterAccounts(account.id,business.business_name,business.id)" v-for ="account in accounts" v-if="account.business == business.id">[[business.business_name]] </a>
      </span>
     
       
      </div>
      </div>
  
</div>
<!-- note a combination of outer class d-flex and inner class ml-auto  position the inner lement to the right of the screen responsively-->
<div class="row d-flex">
  <div class="stocks_display" v-on:click="displayStock()">
  <i class="fa fa-plus fa-2x"></i>
</div>
<!-- <div class="stocks_display ml-auto" v-on:click="moveRight()" v-on:click="moveright = !moveright">
 -->
 <div class="stocks_display ml-auto" v-on:click="moveright = !moveright">

  <i class="fa fa-angle-right fa-2x" style="color:blue;"></i>
</div>
</div>


<div class='row' >

  <div class="display_stock_form" v-if="displaystockform" >
  <form class="form-signin" v-on:submit="checkSubmitStock">
    {% csrf_token %}      
      <div class="form-label-group">
        <input type="number" id="inpuntstockamount" class="form-control" placeholder=" Spent On"  required autofocus v-model="stockamount">
        <label for="inpuntstockamount"> {% trans "stock amount" %} </label>
      </div>

      <div class="row">
      <div class="buttons_stock text-warning" style="margin-left: 10px;" v-on:click="checkSubmitStock(true)">{% trans "opening" %}</div>
        <div class="buttons_stock text-primary" style="margin-left: 60px;" v-on:click="checkSubmitStock(false)"> {% trans "closing" %}</div>
         

      </div>
  </form>
</div>


<!-- animation -->


<!--   <transition
    name="custom-classes-transition"
    enter-active-class="animated tada"
    leave-active-class="animated bounceOutRight"
  >
  <p v-if="show"></p>
  </transition> -->

<!-- end animation -->


<!-- test move right -->

<transition
    name="custom-classes-transition"
    enter-active-class="animated tada"
    leave-active-class="animated bounceOutRight"
  >
<p v-if="!moveright">
 <!-- begin Savings -->

<div class='col-lg-4 col-md-4 col-sm-12 col-12' style="margin-top: 20px; max-height: 800px;
  overflow-y: auto;
  overflow-x: auto;" >
  
<div  style="margin-bottom: 20px;">
  <ul class="list-group" style="margin-bottom: 10px;">
  <li class="list-group-item d-flex justify-content-between lh-condensed">
      <div>
   
        <h4  class="" v-cloak><!-- [[customer.customer_name]] --> {% trans "Savings" %} </h4>
        
      </div>
      <div>

      <h4 class="text-primary align-right" v-cloak > <!--  [[customer_total_order(customer)]] -->[[number_to_Cash(getProfiLoss(false)*0.1) ]]</h4>
        
      </div>
  </li>

</ul> 
<div >

   <ul class="list-group" v-if="false">

      <li class="list-group-item d-flex justify-content-between lh-condensed go3d_cool" v-for= "expense in expenses"    v-cloak>
              <div>
                  <h6  class="my-0" v-cloak>[[ number_to_Cash(getTodaysSavings())]] </h6>
<!--                   <small class="text-muted" v-cloak> [[expense.credit_reason]] </small>
 -->                </div>
                <div>
<!--                 <span v-cloak class="text-primary">Tsh [[expense.credit_amount]] </span>
 -->
                <br>
                <!-- <span aria-hidden="true"  v-if="customer.id == sale.customer" v-cloak>[[customer.customer_name]]</span> -->
                <button type="button" class="close" aria-label="Close" v-on:click="deleteExpenses(expense.id)">

                <span aria-hidden="true">&times;</span>
          </button>
         
                  
                </div>
                
              </li>

   </ul>

</div>
    
  
</div>

</div>

<!-- end Savings -->
</p>
</transition>
<transition
    name="custom-classes-transition"
    enter-active-class="animated tada"
    leave-active-class="animated bounceOutRight"
  >
 <!-- begin Stocks -->
<p v-if="!moveright">

<div class='col-lg-4 col-md-4 col-sm-12 col-12' style="margin-top: 20px; max-height: 800px;
  overflow-y: auto;
  overflow-x: auto;">
  
<div  style="margin-bottom: 20px;">
  
  <ul class="list-group" style="margin-bottom: 10px;">
  <li class="list-group-item d-flex justify-content-between lh-condensed">
      <div>
   
        <h4  class="text-warning" v-cloak><!-- [[customer.customer_name]] --> {% trans "Opening Stocks" %} </h4>
        
      </div>
      <div>

      <h4 class="text-primary align-right" v-cloak > <!--  [[customer_total_order(customer)]] -->{% trans "Closing Stocks" %}</h4>
        
      </div>
  </li>

</ul> 
<div >

  <div class="row container" style="margin-left: 2px;">
       <ul class="list-group column">

      <li class="list-group-item d-flex justify-content-between lh-condensed go3d_cool" v-for= "stock in stocks"    v-cloak v-if="stock.openingstock">
              <div>
                  <h6  class="my-0" v-cloak>[[parseDate(stock.created_at)]] </h6>
                  <small class="text-warning" v-cloak> [[number_to_Cash(stock.amount)]] </small>
                </div>
                <div>
                <!-- <div>
                  <h6  class="my-0" v-cloak>[[stock.amount]] </h6>
                  <small class="text-muted" v-cloak> [[stock.amount]] </small>
                </div> -->
                
                <!-- <span aria-hidden="true"  v-if="customer.id == sale.customer" v-cloak>[[customer.customer_name]]</span> -->
                <button type="button" class="close" aria-label="Close" v-on:click="deleteStock(stock.id)">

                <span aria-hidden="true">&times;</span>
          </button>
         
                  
                </div>
                
              </li>

   </ul>

      <ul class="list-group column">

      <li class="list-group-item d-flex justify-content-between lh-condensed go3d_cool" v-for= "stock in stocks"   v-if="!stock.openingstock" v-cloak>
              <div>
                  <h6  class="my-0" v-cloak>[[parseDate(stock.created_at)]] </h6>
                  <small class="text-primary" v-cloak> [[number_to_Cash(stock.amount)]] </small>
                </div>
                <div>
                <!-- <div>
                  <h6  class="my-0" v-cloak>[[stock.amount]] </h6>
                  <small class="text-muted" v-cloak> [[stock.amount]] </small>
                </div> -->
                
                <!-- <span aria-hidden="true"  v-if="customer.id == sale.customer" v-cloak>[[customer.customer_name]]</span> -->
                <button type="button" class="close" aria-label="Close" v-on:click="deleteStock(stock.id)">

                <span aria-hidden="true">&times;</span>
          </button>
         
                  
                </div>
                
              </li>

   </ul>
  </div>



</div>
    
  
</div>

</div>

<!-- end Stocks -->
</p>
</transition>

<!-- end test move right -->

 <!-- begin Expenses -->

<div class='col-lg-4 col-md-4 col-sm-12 col-12' style="margin-top: 20px; max-height: 800px;
  overflow-y: auto;
  overflow-x: auto;" >
  
<div  style="margin-bottom: 20px;">
  <ul class="list-group" style="margin-bottom: 10px;">
  <li class="list-group-item d-flex justify-content-between lh-condensed">
      <div>
   
        <h4  class="" v-cloak><!-- [[customer.customer_name]] --> {% trans "Expenses" %} </h4>
        
      </div>
      <div>

      <h4 class="text-primary align-right" v-cloak > <!--  [[customer_total_order(customer)]] -->[[getTotalCredit()]]</h4>
        
      </div>
  </li>

</ul> 
<div >

   <ul class="list-group">

      <li class="list-group-item d-flex justify-content-between lh-condensed go3d_cool" v-for= "expense in expenses"    v-cloak>
              <div>
                  <h6  class="my-0" v-cloak>[[expense.credit_to]] </h6>
                  <small class="text-muted" v-cloak> [[expense.credit_reason]] </small>
                </div>
                <div>
                <span v-cloak class="text-primary">Tsh [[expense.credit_amount]] </span>

                <br>
                <!-- <span aria-hidden="true"  v-if="customer.id == sale.customer" v-cloak>[[customer.customer_name]]</span> -->
                <button type="button" class="close" aria-label="Close" v-on:click="deleteExpenses(expense.id)">

                <span aria-hidden="true">&times;</span>
          </button>
         
                  
                </div>
                
              </li>

   </ul>

</div>
    
  
</div>

</div>

<!-- end Expenses -->

<!-- begin Pending sales -->
<div class='col-lg-4 col-md-4 col-sm-12 col-12' style="margin-top: 20px; max-height: 800px;
  overflow-y: auto;
  overflow-x: auto;" v-if="!moveright">

<div  style="margin-bottom: 20px;">
  <ul class="list-group" style="margin-bottom: 10px;">
  <li class="list-group-item d-flex justify-content-between lh-condensed">
      <div>
   
        <h4  class="" v-cloak><!-- [[customer.customer_name]] -->  {% trans "Pending Sales" %}</h4>
        
      </div>
      <div>

      <h4 class="text-muted align-right" v-cloak> <!--  [[customer_total_order(customer)]] -->[[getTotalCreditSales()]]</h4>
        
      </div>
  </li>

</ul> 
<div >

   <ul class="list-group">

      <li class="list-group-item d-flex justify-content-between lh-condensed go3d_cool" v-for= "sale in sales"  v-if="sale.debit_credit"  v-cloak>
                <div>
                  <h6  class="my-0" v-cloak>[[sale.debit_from]] </h6>
                  <small class="text-muted" v-cloak> [[sale.debit_reason]] </small>
                </div>
                <div>
                <span v-cloak class="text-muted" >Tsh [[sale.debit_amount]] </span>

                <br>
                <!-- <span aria-hidden="true"  v-if="customer.id == sale.customer" v-cloak>[[customer.customer_name]]</span> -->
                <button type="button" class="close" aria-label="Close" v-on:click="deleteSale(sale.id)">

                <span aria-hidden="true">&times;</span>
          </button>
         
                </div>
                
              </li>

   </ul>

</div>
    
  
<!--  <button style="margin-top: 10px;" v-on:click="acceptSale(sale.id)" class='btn btn-outline-primary btn-small'>Accept</button>
  <button v-on:click="declineSale(sale.id)" style="margin-top: 10px;" class='btn btn-outline-dark btn-small'>Decline</button> -->

</div>

</div>

<!-- end Pending sales -->


<!-- begin Actual sales -->
<div class='col-lg-4 col-md-4 col-sm-12 col-12' style="margin-top: 20px; max-height: 800px;
  overflow-y: auto;
  overflow-x: auto;" v-if="!moveright">

<div  style="margin-bottom: 20px;">
  <ul class="list-group" style="margin-bottom: 10px;">
  <li class="list-group-item d-flex justify-content-between lh-condensed">
      <div>
   
        <h4  class="" v-cloak><!-- [[customer.customer_name]] -->  {% trans "Actual Sales" %}</h4>
        
      </div>
      <div>

      <h4 class="text-warning align-right" v-cloak> <!--  [[customer_total_order(customer)]] -->[[getTotalCreditSales(false)]]</h4>
        
      </div>
  </li>

</ul> 
<div >

   <ul class="list-group">

      <li class="list-group-item d-flex justify-content-between lh-condensed go3d_cool" v-for= "sale in sales"  v-if="!sale.debit_credit"  v-cloak>
                <div>
                  <h6  class="my-0" v-cloak>[[sale.debit_from]] </h6>
                  <small class="text-muted" v-cloak> [[sale.debit_reason]] </small>
                </div>
                <div>
                <span v-cloak class="text-warning" >Tsh [[sale.debit_amount]] </span>

                <br>
                <!-- <span aria-hidden="true"  v-if="customer.id == sale.customer" v-cloak>[[customer.customer_name]]</span> -->
                <button type="button" class="close" aria-label="Close" v-on:click="deleteSale(sale.id)">

                <span aria-hidden="true">&times;</span>
          </button>
                  
                </div>
                
              </li>

   </ul>

</div>
    
  
<!--  <button style="margin-top: 10px;" v-on:click="acceptSale(sale.id)" class='btn btn-outline-primary btn-small'>Accept</button>
  <button v-on:click="declineSale(sale.id)" style="margin-top: 10px;" class='btn btn-outline-dark btn-small'>Decline</button> -->

</div>

</div>

<!-- end Actual sales -->

</div>

</div>



{%endblock%}

{%block script%}
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/moment.min.js"></script>
 <script>
    moment().format();
</script>
<script type="text/javascript">
  // $.notify('order')

</script>

  <script >




vsale=new Vue({
  delimiters: ['[[', ']]'],
  el: '#debittaccount',
  data: {
    customername:'',
salesamount:'',
saledescription:'',
sales:'',
totalsale:0,
useraccount:'',
salestype:'cash',
edit:false,
saleid:'',
new_edit_button:'New Sale',
accounts:'',
number_of_accounts:'',
profit:"Profit",
expenses:'',
isGrossprofit:true,
isNetprofit:true,
total_expenses:0,
credit_sales:0,
actual_sales:0,
totalsales:0,
selected_business:'All',
businesses:'',
showbusiness:true,
stockamount:'',
displaystockform:false,
userid:'{{user.id}}',
currentbussiness_id:'',
current_language:'{{ LANGUAGE_CODE }}',
show:true,
moveright:false,
stocks:'',
total_closingstock:0,
total_openingstock:0,
  },

  methods:{
    deleteStock:function(id){
      this.$http.delete('/api/stocks/'+id+'/')
       .then(function(response){
        this.title=response.data

        this.getStocks()
        console.log('deleted')
       })
       .catch(function(error){
        this.title='error deleting expenses'
        console.error('stock::delete failed')
       })
    },
    moveRight:function(){
      this.moveright=~this.moveright
    },
    getTotalStocks:function(opening=true){
      var total_stocks=0
      $.each(this.stocks, function(key, value) {
        if(value.openingstock && opening)
           total_stocks+=value.amount;
         else if (!value.openingstock && !opening)
          total_stocks+=value.amount;
         });
      return total_stocks
    },
    getTodaysSavings:function(){
      var today=moment();
      // savings=10% of net profit
      // net profit =actual sales- (opening stock + total expenses -closing stock) 
      // everything for tha particular day

      // get total expenses for today

      todays_expenses = this.expenses.filter(function(expense){
        return moment(expense.created_at).isSame(today,'day')});

        var total_expense_today=0
      $.each(todays_expenses, function(key, value) {
           total_expense_today+=value.credit_amount;
         });

      // get closing stock for today

      todays_closing_stocks = this.stocks.filter(function(stock){
        return moment(stock.created_at).isSame(today,'day')&& !stock.openingstock });
      
        var total_closing_stock_today=0
      $.each(todays_closing_stocks, function(key, value) {
           total_closing_stock_today+=value.amount;
         });

      // get opening stock for today
      todays_opening_stocks = this.stocks.filter(function(stock){
        return moment(stock.created_at).isSame(today,'day')&& stock.openingstock });
      
        var total_opening_stock_today=0
      $.each(todays_opening_stocks, function(key, value) {
           total_opening_stock_today+=value.amount;
         });
      // get todays actual sales
      todays_sales = this.sales.filter(function(sale){
        return moment(sale.created_at).isSame(today,'day') && !sale.debit_credit});
      
        var total_sales_today=0
      $.each(todays_sales, function(key, value) {
           total_sales_today+=value.debit_amount;
         });

      total_profit_today = total_sales_today - (total_opening_stock_today+total_expense_today-total_closing_stock_today)

      if(total_profit_today <0)
        return 0
      else 
      return total_profit_today *0.1
    // retrun saving amount for the day, i.e 10% of the net total profit
    },
    getSavingsAccountBalance:function(){
      // get the balance as per the savings already made in the savings bank account
    },
    getTotalSavings:function(){
      if(this.isNetprofit)return this.getProfiLoss*0.1
        else return 0
    },
    displayStock:function(){
        if(this.displaystockform)this.displaystockform=false;
        else this.displaystockform=true;
    },
    checkSubmitStock:function(opening){
      url='/addstock/'

      

      if(this.selected_business!=this.matchLanguage("All")){
        this.$http.post(url+this.stockamount+'/'+opening+'/'+this.userid+'/'+this.currentbussiness_id+'/',{'amount':this.stockamount,'openingstock':opening,'user':this.userid,'business':this.currentbussiness_id})
       .then(function(response){

        this.stockamount=''
        this.getExpenses()
      this.getSales()
      this.getStocks()
      console.log('sucess')

       })
       .catch(function(error){
        console.error('stock not posted')
       })
      }else{
        $.notify("select a business","error")
      }

      // e.preventDefault();
    },
    // to be changed such that it is used to dispaly  all or a certain debit account
    // and another function which will use the default account fields in the db shall be used foe debit entries
    filterAccounts:function(val,businesname,businessid){
      this.useraccount=val
      this.selected_business=businesname
      this.currentbussiness_id=businessid
      this.getExpenses()
      this.getSales()
      this.getStocks()
    },
    filterStocks:function(stocks){
      userbusiness=this.currentbussiness_id
      newstocks = stocks.filter(function(stock){
        return stock.business==userbusiness
        
      })
      return newstocks
    },
    filterBusiness:function(expenses){
      useraccount=this.useraccount
      newsale = expenses.filter(function(expense){
        return expense.account==useraccount
        
      })
      return newsale
    },
    onShowBusiness:function(){
      this.showbusiness=!this.showbusiness
    },
     getAccount:function(){
     this.$http.get('/api/account')
     .then(function(response){
      this.accounts=response.data
      count=0
      $.each(this.accounts, function(key, value) {
           count+=1;
         });
      this.number_of_accounts=count
      
     })
     .catch(function(error){
      this.title='error getting items'
     })
    },
    getProfiLoss:function(gross=true){
      // remember to add opening and closing stock for the day so as to validate this calculations
      var total_expense =this.total_expenses
      this.total_closingstock=this.getTotalStocks(false)

      this.total_openingstock=this.getTotalStocks(true)

       this.totalsales=this.credit_sales+this.actual_sales 

       // equation is
       // total_sales-(total_opening_stocks -(total_expenses + total_closing_stocks))

       // totalexpenses + total_closing_stock is just total expenses

       // thus

       total_expense=this.total_expenses+this.total_closingstock

       // cost of sale is the sum of the expenses and closing stock subtracted from the opening stock : total_opening_stocks -(total_expenses + total_closing_stocks)

       // thus from here downwards on this function, total expense is actually the cost of sale

       // i think making the cost of sale an absolute value makes more sense , since any negative value for cost of sale will give us so mighty 

       total_expense=Math.abs(this.total_openingstock-total_expense)

      
      // profit /loss with sales on loan
      if(this.totalsales>=total_expense)this.isGrossprofit=true
      else if(this.totalsales<total_expense)this.isGrossprofit=false
     
     // profit/loss with sale without loans
      if(this.actual_sales>=total_expense)this.isNetprofit=true
      else if(this.actual_sales<total_expense)this.isNetprofit=false


      if(gross && this.isGrossprofit )return this.totalsales-total_expense
      else if(gross && !this.isGrossprofit )return total_expense-this.totalsales
      else if(!gross && this.isNetprofit )return this.actual_sales-total_expense
      else if(!gross && !this.isNetprofit )return total_expense-this.actual_sales


    },
    deleteExpenses:function(id){
      this.$http.delete('/api/creditaccount/'+id+'/')
       .then(function(response){
        // this.items=response.data
        this.title=response.data

        this.getExpenses()
        // alert('response')
       })
       .catch(function(error){
        this.title='error deleting expenses'
       })

    },
    getTotalCredit:function(){
      var amount=0;
     $.each(this.expenses, function(key, value) {
        amount+=value.credit_amount
         });
     this.total_expenses=amount
     
      return this.number_to_Cash(amount,'Tsh')

    },
    getSales:function(){
      this.$http.get('/api/debitaccount')
     .then(function(response){
      this.sales=response.data
      if(this.selected_business!=this.matchLanguage("All"))
      this.sales=this.filterBusiness(this.sales)

     })
     .catch(function(error){
      this.title='error getting items'
     })

    },
    getBusiness:function(){
     this.$http.get('/api/business')
     .then(function(response){
      this.businesses=response.data      
     })
     .catch(function(error){
      this.title='error getting items'
     })
    },
    getExpenses:function(){
      this.$http.get('/api/creditaccount')
     .then(function(response){
      this.expenses=response.data
      if(this.selected_business!=this.matchLanguage("All"))
      this.expenses=this.filterBusiness(this.expenses)

     })
     .catch(function(error){
      this.title='error getting items'
     })

    },
    getStocks:function(){
      this.$http.get('/api/stocks')
     .then(function(response){
      this.stocks=response.data

      if(this.selected_business!=this.matchLanguage("All"))
      this.stocks=this.filterStocks(this.stocks)

     
     })
     .catch(function(error){
      this.title='error getting items'
     })

    },
    parseDate:function(date){
        var today=moment();

    if(moment(date).isSame(today,'day'))
      return 'Today';
      else
    return moment(date).format('LL');

    },
    number_to_Cash:function(number,currency="Tsh"){

       amount = currency + number.toFixed(2).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
     return amount;

    },
    getTotalSales:function(now=false){
      var amount=0;
     if(!now){
      $.each(this.sales, function(key, value) {
           if(!value.debit_credit ){
            amount+=value.debit_amount
             }
         });

     } else{
      $.each(this.sales, function(key, value) {
            amount+=value.debit_amount
             
         });

     }
     
     
    return this.number_to_Cash(amount,'Tsh')
    },
    getTotalCreditSales:function(credit=true){
      var amount=0;

     $.each(this.sales, function(key, value) {
           if(value.debit_credit && credit ){
            amount+=value.debit_amount
             }else if(!value.debit_credit && !credit){
              amount+=value.debit_amount
             }
         });

     if(credit)this.credit_sales=amount
     else this.actual_sales=amount
     
    return this.number_to_Cash(amount,'Tsh')

    },


    editSales:function(id,customername,amount,reason){
      this.saleid=id;
      this.customername=customername;
        this.salesamount=amount;
        this.saledescription=reason;
        this.edit=true;
        this.new_edit_button="Edit Sale"
    },
    deleteSale:function(id){
      this.$http.delete('/api/debitaccount/'+id+'/')
       .then(function(response){
        // this.items=response.data
        this.title=response.data
        this.getSales()
        // alert('response')
       })
       .catch(function(error){
        this.title='error getting items'
       })
    },
    acceptSale:function(id){
        this.$http.post('/debitaccount/'+id+'/',{'id':id})
       .then(function(response){
        // this.items=response.data
        this.title=response.data
        this.getSales()

       })
       .catch(function(error){
        this.title='error getting items'
       })

    },
    matchLanguage:function(word){
      new_word=word
        if (word=="All"){
          if(this.current_language=='en'){
              new_word=word      
          }
          else if(this.current_language=='sw'){
              new_word="Zote"
          }
        
        }
        return new_word

    },

    declineSale:function(id){


    },
    },

    beforeMount(){
      console.log(this.current_language)
    if(this.current_language=='en'){
      console.log('got english')
      
      this.selected_business="All"
    }
    else if(this.current_language=='sw'){
      console.log('got swahili')
      this.selected_business="Zote"
    }

    this.getSales()
    this.getAccount()
    this.getExpenses()
    this.getBusiness()
    this.getStocks()

    }
  }
)
  </script>
{%endblock%}